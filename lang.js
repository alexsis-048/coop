/* lang.js — полное покрытие RU/UA
   - Основной способ: data-i18n / data-i18n-html
   - Резервный способ: авто-замена текста в узлах (для элементов без ключей)
*/

const translations = {
  uk: {
    // Базовое
    page_title: "Членські внески",
    org_name: "Харчовик-2",
    nav_cabinet: "Особистий кабінет",

    // Про кооператив — рівно 3 абзаци
    about_title: "Про кооператив",
    about_p1:
      "Це територія площею 13.2 га, яку було виділено для колективного садівництва згідно з рішення виконкома Біляївської районної ради народних депутатів № 502 від 1 грудня 1988 року.",
    about_p2:
      "Засновниками СК «Харчовик-2» на даній земельній ділянці були різні садівничі масиви:  АТ «Одесхарчокомбінат», ОКБ, ДОСААФ та інші. Сьогодні загальна чисельність садових ділянок складає 256 одиниць.",
    about_p3:
      "Відповідно до виписки з Єдиного державного реєстру юридичних осіб та фізичних осіб-підприємців місце знаходження юридичної особи: Україна, 67631, Одеська область, Біляївський р-н, с.Берегове.",

    // Заголовки таблиць
    intro_fee_title: "Вступний внесок",
    intro_case: "Вступ",
    basis: "Підстава",
    years_title: "Членські внески",
    years: "Роки",
    amount: "Розмір",
    target_fees_title: "Цільові внески",
    target: "Ціль",
    terms: "Строки / Примітка",
    electricity_title: "Оплата за електроенергію",
    water_title: "Оплата за водопостачання",
    name: "Найменування",
    tariff: "Тарифи за електроенергію, за 1 кВт·год",
    tariff_water: "Тарифи за водопостачання, за 1 м³",
    land_tax_title: "Податок на землю",
    land_tax_param: "Параметр",
    land_tax_value: "Значення",
    position_fio: "Посада / ПІБ",
    phone: "Прямий номер",
    contacts_title: "Наші контакти",

    // Рядки/фразы, которые встречаются в таблицах
    intro_purchase: "При купівлі – продажу (даруванні) ділянки",
    intro_family: "У разі родинного переоформлення",
    free: "Безкоштовно",
    meter_single: "Однозонний (однотарифний) лічильник",
    meter: "Лічильник",

    // Податок на землю — таблиця
    for_own_plot: "Категорія",
    for_own_plot_val: "За власну ділянку",
    cadastral_label: "Умова",
    cadastral: "У разі наявності кадастрового номера",
    calc_contact_label: "Розрахунок",
    calc_contact:
      "За розрахунком звертайтесь до Маринівської сільради Біляївського району",
    deadline_tax_label: "Строк сплати",
    deadline_tax: "До 1 серпня поточного року",
    contacts_label: "Контакти",
    land_tax_contacts_html:
      "т.м.&nbsp;067&nbsp;420&nbsp;87&nbsp;52 — Світлана&nbsp;Миколаївна<br>с.&nbsp;Маринівка, вул.&nbsp;Покровська,&nbsp;1,&nbsp;каб.&nbsp;3"
  },

  ru: {
    // Базовое
    page_title: "Членские взносы",
    org_name: "Харчовик-2", // не переводим по требованию
    nav_cabinet: "Личный кабинет",

    // О кооперативе — ровно 3 абзаца
    about_title: "О кооперативе",
    about_p1:
      "Это территория площадью 13.2 га, выделенная для коллективного садоводства согласно решению исполкома Беляевского районного совета народных депутатов № 502 от 1 декабря 1988 года.",
    about_p2:
      "Учредителями СК «Пищевик-2» на данном земельном участке были разные садоводческие массивы: АО «Одессхарчокомбинат», ОКБ, ДОСААФ и другие. Сегодня общее количество садовых участков составляет 256 единиц.",
    about_p3:
      "Согласно выписке из Единого государственного реестра юридических лиц и физических лиц-предпринимателей местонахождение юридического лица: Украина, 67631, Одесская область, Беляевский р-н, с. Берегово.",

    // Заголовки таблиц
    intro_fee_title: "Вступительный взнос",
    intro_case: "Вступление",
    basis: "Основание",
    years_title: "Членские взносы",
    years: "Годы",
    amount: "Размер",
    target_fees_title: "Целевые взносы",
    target: "Цель",
    terms: "Сроки / Примечание",
    electricity_title: "Оплата за электроэнергию",
    water_title: "Оплата за водоснабжение",
    name: "Наименование",
    tariff: "Тариф за 1 кВт·ч",
    tariff_water: "Тариф за 1 м³",
    land_tax_title: "Налог на землю",
    land_tax_param: "Параметр",
    land_tax_value: "Значение",
    position_fio: "Должность / ФИО",
    phone: "Прямой номер",
    contacts_title: "Наши контакты",

    // Рядки/фразы, которые встречаются в таблицах
    intro_purchase: "При купле-продаже (дарении) участка",
    intro_family: "При семейном переоформлении",
    free: "Бесплатно",
    meter_single: "Однозонный (однотарифный) счётчик",
    meter: "Счётчик",

    // Налог на землю — таблица
    for_own_plot: "Категория",
    for_own_plot_val: "За собственный участок",
    cadastral_label: "Условие",
    cadastral: "При наличии кадастрового номера",
    calc_contact_label: "Расчёт",
    calc_contact:
      "За расчётом обращайтесь в Мариновский сельсовет Беляевского района",
    deadline_tax_label: "Срок уплаты",
    deadline_tax: "До 1 августа текущего года",
    contacts_label: "Контакты",
    land_tax_contacts_html:
      "т.&nbsp;моб. 067&nbsp;420&nbsp;87&nbsp;52 — Светлана&nbsp;Николаевна<br>с.&nbsp;Мариновка, ул.&nbsp;Покровская,&nbsp;1, каб.&nbsp;3"
  }
};

/* ---------- Хелперы ---------- */
function applyTranslation(el, value) {
  if (el.hasAttribute("data-i18n-html")) {
    el.innerHTML = value;
  } else {
    el.textContent = value;
  }
}

/* Автоперевод для оставшихся текстов (табличные ячейки без ключей и т.п.) */
const autoMapUA2RU = [
  // Частые ячейки/фразы
  ["До 0,6 сот", "До 0,6 сотки"],
  ["Більше 0,6 сот", "Более 0,6 сотки"],
  ["Благоустрій", "Благоустройство"],
  ["Обслуговування системи водопостачання", "Обслуживание системы водоснабжения"],
  ["Компенсація втрат ВВЛ та трансформаторі", "Компенсация потерь ВЛ и на трансформаторе"],
  ["З користувачів водогону", "С пользователей водопровода"],
  ["Абонентів масиву «Зав’яза»", "Абонентов массива «Завяза»"],
  ["Ремонт лічильника", "Ремонт счётчика"],
  ["Ремонт накопичувальних ємностей", "Ремонт накопительных емкостей"],
  ["Ремонт водогінного вузла", "Ремонт водопроводного узла"],
  ["Для користувачів «Зав’яза»", "Для пользователей «Завяза»"],
  ["щорічно", "ежегодно"],
  ["строк до", "срок до"],
  ["серпня", "августа"],
  ["червня", "июня"],
  ["липня", "июля"],
  ["Найменування", "Наименование"],
  ["Тарифи за електроенергію, за 1 кВт·год", "Тариф за 1 кВт·ч"],
  ["Тарифи за водопостачання, з 1 м³", "Тариф за 1 м³"],
  ["Сума", "Сумма"],
  ["Розмір", "Размер"]
];

/* Обход DOM и замена текстовых узлов (кроме элементов, уже помеченных data-i18n*) */
function autoReplaceToRU(root = document.body) {
  const skipSelector = "[data-i18n],[data-i18n-html]";
  const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, {
    acceptNode(node) {
      if (!node.nodeValue) return NodeFilter.FILTER_REJECT;
      // пропускаем пустяки/пробелы и места, где текст задаётся переводчиком
      const parent = node.parentElement;
      if (!parent || parent.closest(skipSelector)) return NodeFilter.FILTER_REJECT;
      const text = node.nodeValue.trim();
      if (!text) return NodeFilter.FILTER_REJECT;
      // не трогаем «Харчовик-2»
      if (text.includes("Харчовик-2")) return NodeFilter.FILTER_REJECT;
      return NodeFilter.FILTER_ACCEPT;
    }
  });

  const nodes = [];
  while (walker.nextNode()) nodes.push(walker.currentNode);

  nodes.forEach(n => {
    let t = n.nodeValue;
    autoMapUA2RU.forEach(([ua, ru]) => {
      // точечная замена с учётом разных пробелов/неразрывных
      const re = new RegExp(ua.replace(/[.*+?^${}()|[\]\\]/g, "\\$&").replace(/\s/g, "\\s+"), "g");
      t = t.replace(re, ru);
    });
    n.nodeValue = t;
  });
}

/* Основная функция переключения языка */
function setLanguage(lang) {
  const dict = translations[lang] || translations.uk;

  // 1) Точная подстановка по ключам
  document.querySelectorAll("[data-i18n],[data-i18n-html]").forEach(el => {
    const key = el.getAttribute("data-i18n") || el.getAttribute("data-i18n-html");
    if (key in dict) applyTranslation(el, dict[key]);
  });

  // 2) Автоперевод оставшегося текста (только в RU)
  if (lang === "ru") {
    autoReplaceToRU(document.body);
  } else {
    // при возврате на украинский можно просто перезагрузить по ключам,
    // а авто-замены нам не нужны (исходный контент — украинский)
  }

  document.documentElement.lang = lang;
  localStorage.setItem("lang", lang);
}

/* Инициализация */
document.addEventListener("DOMContentLoaded", () => {
  const saved = localStorage.getItem("lang") || "uk";
  setLanguage(saved);
});
